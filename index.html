<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title></title>
  <script>
    // FIXME this script block should prevent page display until the service worker is ready (which may require page reload).
    if (!navigator.serviceWorker.controller) {
      navigator.serviceWorker.register('./serviceworker.js', {scope: './'});
    }
    navigator.serviceWorker.ready
            .then(rego => {
              console.debug(rego);
              console.debug(navigator.serviceWorker.controller);
              if (!navigator.serviceWorker.controller) { // indicates the page was force reloaded
                location.reload(); // alternative could be to message the serviceworker to claim the client.
              }
            });
  </script>
  <link rel="stylesheet" href="css/style.css">
  <meta name="description" content="">
  <style type="text/css">
    html, body {
      width: 100vw;
      height: 100vh;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      overflow-x: hidden;
      overflow-y: auto;
    }
    body {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: stretch;
    }
    body > * {
      width: 100vw;
      height: 100vh;
    }
    iframe {
      border: none;
      margin: 0;
    }
    dialog {
      margin: 0;
      border: none;
      padding: 0;
      max-width: 100vw;
      max-height: 100vh;
      overflow: clip;
    }
    dialog > form {
      width: 100%;
      height: 100%;
      margin: 0;
      border: 5px solid transparent;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    form:hover {
      border-color: orange;
    }
    fieldset {
    }
    label {
      display: block;
      font-size: 16pt;
    }
    input[type=file] {
      display: block;
      font-size: 16pt;
      padding: 8pt;
      color: lightblue;
      border: 2px dashed lightgray;
    }
    input[type=file]::file-selector-button {
      background-color: transparent;
      color: transparent;
      display: block;
      border: none;
      margin: 0;
      padding: 0;
      width: 0;
      height: 0;
    }
  </style>
</head>
<body>
<dialog id="dialog">
  <form id="configure" method="dialog">
    <h1>RSMF Viewer</h1>
    <fieldset>
      <label>Drag the rsmf.zip file or click to select.</label>
      <input type="file" id="file-picker" title="" required />
    </fieldset>
  </form>
</dialog>
  <iframe id="viewer"></iframe>
</body>
<script>
{
  const configForm = document.querySelector('form[id=configure]');
  configForm.addEventListener('click', (e) => {
    const fileInput = e.currentTarget.querySelector('input[type=file]');
    if (e.target !== fileInput) {
      e.preventDefault();
      e.stopPropagation();
      fileInput.click();
    }
  });
  configForm.addEventListener('dragenter', (e) => e.preventDefault());
  configForm.addEventListener('dragover', (e) => e.preventDefault());
  configForm.addEventListener('drop', async (e) => {
    e.preventDefault();
    const fileInput = e.currentTarget.querySelector('input[type=file]');
    const dataTransfer = new DataTransfer();
    dataTransfer.items.add(e.dataTransfer.files[0]);
    fileInput.files = dataTransfer.files;
    fileInput.dispatchEvent(new Event('change'));
  });
  document.getElementById('dialog').showModal();
}
</script>
<script src="./js/filestore.js"></script>
<script type="module">
  // FIXME are filenames in the rsmf.zip case sensitive??
  import { Zip } from './js/vendor/ndesmic-zip/zip.js';
  // FIXME when Firefox supports module ServiceWorkers
  // import { FileStore } from './js/filestore.js';
  const RSMF_MANIFEST_FILENAME = 'rsmf_manifest.json';
  const BASE_DIR = 'rsmf';
  const DATA_DIR = Date.now();
  let fileStore = new FileStore([BASE_DIR, DATA_DIR], {create: true});
  document.querySelector('#file-picker').addEventListener('change', async (ev) => {
    let filesPicker = ev.currentTarget;
    if (filesPicker.files.length > 1) return;
    const file = filesPicker.files[0];
    console.info(`Selected ${file.name}: `, file);
    const reader = new FileReader();
    reader.onload = async () => {
      let zip;
      try {
        zip = new Zip(reader.result);
      }
      catch (ex) {
        filesPicker.setCustomValidity('Corrupted or invalid ZIP file.')
        filesPicker.reportValidity();
        return;
      }
      if (zip.entries.find(entry => entry.fileName === RSMF_MANIFEST_FILENAME) == null) {
        filesPicker.setCustomValidity(`ZIP file does not contain "${RSMF_MANIFEST_FILENAME}"`);
        filesPicker.reportValidity();
        return;
      }
      await zip.entries.reduce((promise, entry) => promise.then(() => saveFile(entry)), Promise.resolve());
      const viewer = document.querySelector('#viewer');
      document.getElementById('dialog').close();
      viewer.src = 'viewer.html?data=' + fileStore.getBasePath();
    }
    reader.readAsArrayBuffer(file);
  });

  async function saveFile(entry) {
    console.info(`Extracting ${entry.fileName}: `, entry);
    const blob = await entry.extract()
    const fileHandle = await fileStore.getFileHandle(entry.fileName);
    const writable = await fileHandle.createWritable(); // FIXME not implemented in Safari
    await writable.write(blob);
    await writable.close();
  }

  window.addEventListener('beforeunload', async (ev) => {
    await fileStore.remove();
  });
</script>
</html>
