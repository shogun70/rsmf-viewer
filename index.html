<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title></title>
  <link rel="stylesheet" href="css/style.css">
  <meta name="description" content="">
  <script>
    var dataPath = 'rsmf/'; // FIXME maybe something random - would need to co-ordinate with SW.
  </script>
  <script>
    if (!navigator.serviceWorker.controller) {
      navigator.serviceWorker.register('./serviceworker.js', {scope: './'});
    }
    navigator.serviceWorker.ready
            .then(rego => {
              console.log(rego);
              console.log(navigator.serviceWorker.controller);
              if (!navigator.serviceWorker.controller) location.reload();
            });
  </script>
  <script src="js/app.js"></script>
  <style type="text/css">
    html, body {
      width: 100vw;
      height: 100vh;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      overflow-x: hidden;
      overflow-y: auto;
    }
    body {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: stretch;
    }
    body > iframe {
      height: 100%;
    }
  </style>
</head>
<body>
  <button id="rsmf-chooser">Choose RSMF</button>

  <iframe id="viewer"></iframe>
</body>

<script type="module">
  import { Zip } from "./js/vendor/ndesmic-zip/zip.js";
  var opfsRoot = await navigator.storage.getDirectory();
  document.querySelector('#rsmf-chooser').addEventListener('click', async (e) => {
          const pickerOpts = {
            types: [
              {
                description: "RSMF Zip",
                accept: {
                  "application/*": [".zip"],
                },
              },
            ],
            excludeAcceptAllOption: false,
            multiple: false,
          };
          let handle;
          [handle] = await window.showOpenFilePicker(pickerOpts);
          const file = await handle.getFile();
          console.info(file);
          const reader = new FileReader();
          reader.onload = () => {
            opfsRoot.remove();
            const zip = new Zip(reader.result);
            zip.entries.reduce((promise, e) => promise.then(() => saveFile(e)), Promise.resolve());
            const viewer = document.querySelector('#viewer');
            viewer.src = 'about:blank'; // FIXME does this do anything?
            viewer.src = 'viewer.html?data=' + dataPath;
          };
          reader.readAsArrayBuffer(file);
  });

  async function saveFile(entry) {
    console.info("fileName: ", entry.fileName);
    const blob = await entry.extract()
    const fileHandle = await opfsRoot.getFileHandle(entry.fileName, {create: true});
    const writable = await fileHandle.createWritable();
    await writable.write(blob);
    await writable.close();
  }

</script>
</html>
